---
import PrimaryCTA from "@components/ui/buttons/PrimaryCTA.astro";
import Icon from "@components/ui/icons/Icon.astro";

const { pricing, id } = Astro.props;
---

<section
  id={id}
  class="mx-auto max-w-[85rem] px-4 py-10 sm:px-6 lg:px-8 lg:py-14 2xl:max-w-full"
>
  <!-- Section heading -->
  <div class="mx-auto mb-10 max-w-2xl text-center lg:mb-14">
    <h2
      class="text-balance text-2xl font-bold tracking-tight text-neutral-800 dark:text-neutral-200 md:text-4xl md:leading-tight"
    >
      {pricing.title}
    </h2>
    <p class="mt-1 text-pretty text-neutral-600 dark:text-neutral-400">
      {pricing.subTitle}
    </p>
  </div>

  <!-- Interactive Pricing Calculator -->
  <div class="mx-auto max-w-4xl">
        <!-- Billing Toggle -->
    <div class="mb-8 flex items-center justify-center">
      <div class="bg-muted rounded-lg p-1 flex items-center dark:bg-neutral-700">
        <button
          id="monthly-btn"
          class="px-6 py-2 rounded-md text-sm font-medium transition-all duration-200 bg-white shadow-sm text-primary border border-primary/20 dark:bg-neutral-900 dark:text-primary-dark dark:border-primary-dark"
        >
          {pricing.billingToggle.monthly}
        </button>
        <button
          id="yearly-btn"
          class="px-6 py-2 rounded-md text-sm font-medium transition-all duration-200 text-neutral-600 hover:text-neutral-800 dark:text-neutral-300 dark:hover:text-white border border-transparent"
        >
          {pricing.billingToggle.yearly}
          <span class="ml-2 inline-flex items-center rounded-full bg-green-100 px-2 py-0.5 text-xs font-medium text-green-800 dark:bg-green-900 dark:text-green-200">
            {pricing.billingToggle.yearlySavings}
          </span>
        </button>
      </div>
    </div>

    <!-- Student Count Slider -->
    <div class="mb-8">
      <div class="flex items-center justify-between mb-4">
        <label for="student-slider" class="text-lg font-medium text-neutral-800 dark:text-neutral-200">
          {pricing.sliderLabel}
        </label>
        <span id="student-count" class="text-2xl font-bold text-primary dark:text-primary-dark">
          50
        </span>
      </div>

      <!-- Custom slider container -->
      <div class="relative">
        <input
          id="student-slider"
          type="range"
          min="0"
          max="1000"
          value="50"
          step="1"
          class="absolute inset-0 w-full h-2 opacity-0 cursor-pointer z-10"
        />
        <!-- Visible thumb overlay -->
        <div id="slider-thumb" class="absolute top-1/2 w-5 h-5 bg-primary rounded-full border-2 border-white shadow-lg transform -translate-y-1/2 -translate-x-1/2 pointer-events-none z-20 dark:bg-primary-dark" style="left: 5%"></div>
        <div class="h-2 bg-muted rounded-lg relative dark:bg-muted-dark">
          <div id="progress-fill" class="h-2 bg-gradient-to-r from-primary to-primary-light rounded-lg transition-all duration-300 dark:from-primary-dark dark:to-primary-dark" style="width: 5%"></div>
        </div>
      </div>


    </div>

    <!-- Pricing Card -->
    <div class="mx-auto max-w-2xl">
      <div class="relative rounded-xl border-2 border-primary/20 bg-primary/5 p-8 shadow-lg transition-all duration-200 hover:shadow-xl dark:bg-primary-dark/20 dark:border-primary-dark/40">
        <div class="mb-6 text-center">
          <h3 class="text-2xl font-bold text-primary dark:text-primary-dark mb-2" id="pack-name">
            Pack Start
          </h3>
          <p class="text-sm text-muted-foreground dark:text-muted-foreground-dark">
            Tarif adapté à la taille de votre communauté
          </p>
        </div>

        <div class="mb-6">
          <div class="flex items-baseline justify-center">
            <span id="total-price" class="text-4xl font-bold text-primary dark:text-primary-dark">80.00</span>
            <span class="ml-1 text-xl text-primary dark:text-primary-dark">€</span>
            <span id="period" class="ml-2 text-lg text-muted-foreground dark:text-muted-foreground-dark">/mois</span>
          </div>
          <div class="mt-2 text-center">
            <span id="price-per-student" class="text-sm text-muted-foreground dark:text-muted-foreground-dark">
              Tarif de base : 80€/mois jusqu'à 50 membres
            </span>
          </div>
        </div>

        <div class="mb-6">
          <h4 class="font-semibold text-neutral-800 dark:text-neutral-200 mb-3">Tarification progressive :</h4>
          <ul class="space-y-2 text-sm">
            <li class="flex items-center gap-2 p-2 rounded-lg transition-all duration-200" id="tranche-1a">
              <Icon name="checkCircle" class="h-4 w-4 text-muted-foreground dark:text-muted-foreground-dark" />
              <span id="tranche-1a-text" class="text-muted-foreground dark:text-muted-foreground-dark">80€/mois fixe (1-50 membres)</span>
            </li>
            <li class="flex items-center gap-2 p-2 rounded-lg transition-all duration-200" id="tranche-1b">
              <Icon name="checkCircle" class="h-4 w-4 text-muted-foreground dark:text-muted-foreground-dark" />
              <span id="tranche-1b-text" class="text-muted-foreground dark:text-muted-foreground-dark">80€ + 1.00€/membre supplémentaire (51-250 membres)</span>
            </li>
            <li class="flex items-center gap-2 p-2 rounded-lg transition-all duration-200" id="tranche-2">
              <Icon name="checkCircle" class="h-4 w-4 text-muted-foreground dark:text-muted-foreground-dark" />
              <span id="tranche-2-text" class="text-muted-foreground dark:text-muted-foreground-dark">240€ + 0.60€/membre supplémentaire (251-500 membres)</span>
            </li>
            <li class="flex items-center gap-2 p-2 rounded-lg transition-all duration-200" id="tranche-3">
              <Icon name="checkCircle" class="h-4 w-4 text-muted-foreground dark:text-muted-foreground-dark" />
              <span id="tranche-3-text" class="text-muted-foreground dark:text-muted-foreground-dark">360€ + 0.44€/membre supplémentaire (501+ membres)</span>
            </li>
          </ul>
        </div>

        <!-- Formulaire de contact pour tarification -->
        <form id="pricing-form" class="mb-6 space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="firstName" class="block text-sm font-medium text-neutral-800 dark:text-neutral-200 mb-1">
                Prénom *
              </label>
              <input
                type="text"
                id="firstName"
                name="firstName"
                required
                class="w-full px-3 py-2 border border-neutral-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-neutral-800 dark:border-neutral-600 dark:text-white"
              />
            </div>
            <div>
              <label for="lastName" class="block text-sm font-medium text-neutral-800 dark:text-neutral-200 mb-1">
                Nom *
              </label>
              <input
                type="text"
                id="lastName"
                name="lastName"
                required
                class="w-full px-3 py-2 border border-neutral-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-neutral-800 dark:border-neutral-600 dark:text-white"
              />
            </div>
          </div>

          <div>
            <label for="email" class="block text-sm font-medium text-neutral-800 dark:text-neutral-200 mb-1">
              Email *
            </label>
            <input
              type="email"
              id="email"
              name="email"
              required
              class="w-full px-3 py-2 border border-neutral-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-neutral-800 dark:border-neutral-600 dark:text-white"
            />
          </div>

          <div>
            <label for="phone" class="block text-sm font-medium text-neutral-800 dark:text-neutral-200 mb-1">
              Téléphone
            </label>
            <input
              type="tel"
              id="phone"
              name="phone"
              class="w-full px-3 py-2 border border-neutral-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-neutral-800 dark:border-neutral-600 dark:text-white"
            />
          </div>

          <!-- Honeypot field -->
          <input type="text" name="emai" style="display: none;" />

          <!-- Champs cachés pour les données de tarification -->
          <input type="hidden" id="memberCount" name="memberCount" value="50" />
          <input type="hidden" id="isYearly" name="isYearly" value="false" />
          <input type="hidden" id="totalPrice" name="totalPrice" value="80.00" />
          <input type="hidden" id="pricePerMember" name="pricePerMember" value="1.60" />

          <button
            type="submit"
            class="w-full bg-primary hover:bg-primary-dark text-white font-medium py-3 px-6 rounded-lg transition-colors duration-200 dark:bg-primary-dark dark:hover:bg-primary"
          >
            Demander cette tarification
          </button>
        </form>

        <div id="form-success" class="hidden mb-6 p-4 bg-green-100 border border-green-400 text-green-700 rounded-lg dark:bg-green-900 dark:border-green-700 dark:text-green-200">
          <p class="font-medium">✅ Demande envoyée !</p>
          <p class="text-sm">Nous vous recontacterons rapidement pour finaliser votre commande.</p>
        </div>

        <div id="form-error" class="hidden mb-6 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg dark:bg-red-900 dark:border-red-700 dark:text-red-200">
          <p class="font-medium">❌ Erreur</p>
          <p class="text-sm">Une erreur s'est produite. Veuillez réessayer ou nous contacter directement.</p>
        </div>
      </div>
    </div>

    <!-- Note -->
    <div class="mt-8 text-center">
      <p class="text-sm text-muted-foreground">
        {pricing.note}
      </p>
    </div>
  </div>
</section>

<style>
  /* Custom slider styling */
  #student-slider {
    -webkit-appearance: none;
    appearance: none;
  }

  #student-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    height: 20px;
    width: 20px;
    border-radius: 50%;
    background: var(--color-primary);
    cursor: pointer;
    border: 2px solid var(--color-background);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  }

  #student-slider::-moz-range-thumb {
    height: 20px;
    width: 20px;
    border-radius: 50%;
    background: var(--color-primary);
    cursor: pointer;
    border: 2px solid var(--color-background);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  }
</style>

<script>
      // Tarification progressive avec prix cibles
  function calculatePrice(studentCount: number) {
    let totalPrice = 0;
    let packName = "";

    if (studentCount <= 50) {
      // 1-50 membres : 80€/mois (prix fixe)
      totalPrice = 80;
      packName = "Tarif de base";
    } else if (studentCount <= 250) {
      // 51-250 membres : 80 + (n-51) × 1,00€
      const extraStudents = studentCount - 51;
      totalPrice = 80 + (extraStudents * 1.00);
      packName = "Tarif progressif";
    } else if (studentCount <= 500) {
      // 251-500 membres : 240 + (n-251) × 0,60€
      const extraStudents = studentCount - 251;
      totalPrice = 240 + (extraStudents * 0.60);
      packName = "Tarif avancé";
    } else {
      // 501+ membres : 360 + (n-501) × 0,4375€
      const extraStudents = studentCount - 501;
      totalPrice = 360 + (extraStudents * 0.4375);
      packName = "Tarif sur mesure";
    }

    return { totalPrice, packName };
  }

  // DOM elements
  const studentSlider = document.getElementById('student-slider') as HTMLInputElement;
  const studentCount = document.getElementById('student-count');
  const monthlyBtn = document.getElementById('monthly-btn');
  const yearlyBtn = document.getElementById('yearly-btn');
  const progressFill = document.getElementById('progress-fill') as HTMLElement;
  const sliderThumb = document.getElementById('slider-thumb') as HTMLElement;

  let isYearly = false;





                // Update all prices
  function updatePrices() {
    const students = parseInt(studentSlider.value);

    if (studentCount) {
      studentCount.textContent = students.toString();
    }

    // Update slider background with correct percentage calculation
    const minStudents = 0;
    const maxStudents = 1000;
    const percentage = Math.min(100, Math.max(0, ((students - minStudents) / (maxStudents - minStudents)) * 100));

    // Update the progress fill bar
    if (progressFill) {
      progressFill.style.width = `${percentage}%`;
    }

    // Update the slider thumb position
    if (sliderThumb) {
      sliderThumb.style.left = `${percentage}%`;
    }

    // Calculate price
    const { totalPrice: monthlyPrice, packName } = calculatePrice(students);

    // Calcul annuel selon la tarification progressive (mensuel × 12 × 0.8)
    let yearlyPrice;
    if (students <= 50) {
      yearlyPrice = 768; // 80€ × 12 × 0.8 = 768€
    } else if (students <= 250) {
      const extraStudents = students - 51;
      yearlyPrice = 768 + (extraStudents * 9.6); // (80€ + extraStudents × 0.80€) × 12 × 0.8
    } else if (students <= 500) {
      const extraStudents = students - 251;
      yearlyPrice = 2304 + (extraStudents * 5.76); // (240€ + extraStudents × 0.48€) × 12 × 0.8
    } else {
      const extraStudents = students - 501;
      yearlyPrice = 3456 + (extraStudents * 4.2); // (360€ + extraStudents × 0.35€) × 12 × 0.8
    }

    const totalPrice = isYearly ? yearlyPrice : monthlyPrice;

    // Update price display
    const totalPriceElement = document.getElementById('total-price');
    const periodElement = document.getElementById('period');
    const pricePerStudentElement = document.getElementById('price-per-student');
    const packNameElement = document.getElementById('pack-name');

    if (totalPriceElement) {
      totalPriceElement.textContent = totalPrice.toFixed(2);
    }

    if (periodElement) {
      periodElement.textContent = isYearly ? '/an' : '/mois';
    }

    if (packNameElement) {
      packNameElement.textContent = packName;
    }

    if (pricePerStudentElement) {
      const pricePerStudent = totalPrice / students;
      pricePerStudentElement.textContent =
        isYearly
          ? `Tarif annuel : ${pricePerStudent.toFixed(2)}€/membre/an`
          : `Tarif mensuel : ${pricePerStudent.toFixed(2)}€/membre/mois`;
    }

    // Update tranche highlighting
    updateTrancheHighlighting(students);
  }

  function updateTrancheHighlighting(students: number) {
    const tranches = [
      { id: 'tranche-1a', active: students <= 50 },
      { id: 'tranche-1b', active: students > 50 && students <= 250 },
      { id: 'tranche-2', active: students > 250 && students <= 500 },
      { id: 'tranche-3', active: students > 500 }
    ];

    tranches.forEach(tranche => {
      const element = document.getElementById(tranche.id);
      if (element) {
        const icon = element.querySelector('svg');
        const text = element.querySelector('span');

        if (tranche.active) {
          // Tranche active
          element.classList.add('bg-primary/10', 'border', 'border-primary/20', 'dark:bg-primary-dark/20', 'dark:border-primary-dark/40');
          element.classList.remove('bg-transparent', 'border-transparent');
          if (icon) {
            icon.classList.remove('text-muted-foreground', 'dark:text-muted-foreground-dark');
            icon.classList.add('text-primary', 'dark:text-primary-dark');
          }
          if (text) {
            text.classList.remove('text-muted-foreground', 'dark:text-muted-foreground-dark');
            text.classList.add('text-primary', 'dark:text-primary-dark', 'font-medium');
          }
        } else {
          // Tranche inactive
          element.classList.remove('bg-primary/10', 'border', 'border-primary/20', 'dark:bg-primary-dark/20', 'dark:border-primary-dark/40');
          element.classList.add('bg-transparent', 'border-transparent');
          if (icon) {
            icon.classList.remove('text-primary', 'dark:text-primary-dark');
            icon.classList.add('text-muted-foreground', 'dark:text-muted-foreground-dark');
          }
          if (text) {
            text.classList.remove('text-primary', 'dark:text-primary-dark', 'font-medium');
            text.classList.add('text-muted-foreground', 'dark:text-muted-foreground-dark');
          }
        }
      }
    });
  }

  // Event listeners
  if (studentSlider) {
    studentSlider.addEventListener('input', updatePrices);
    studentSlider.addEventListener('change', updatePrices);
  }

    // Billing toggle event listeners
  if (monthlyBtn && yearlyBtn) {
    monthlyBtn.addEventListener('click', () => {
      isYearly = false;
      updateBillingUI();
      updatePrices();
      updateTrancheTexts();
    });

    yearlyBtn.addEventListener('click', () => {
      isYearly = true;
      updateBillingUI();
      updatePrices();
      updateTrancheTexts();
    });
  }

  function updateTrancheTexts() {
    const tranche1aText = document.getElementById('tranche-1a-text');
    const tranche1bText = document.getElementById('tranche-1b-text');
    const tranche2Text = document.getElementById('tranche-2-text');
    const tranche3Text = document.getElementById('tranche-3-text');

    if (isYearly) {
      if (tranche1aText) tranche1aText.textContent = '768€/an fixe (1-50 membres)';
      if (tranche1bText) tranche1bText.textContent = '768€ + 9.60€/membre supplémentaire (51-250 membres)';
      if (tranche2Text) tranche2Text.textContent = '2304€ + 5.76€/membre supplémentaire (251-500 membres)';
      if (tranche3Text) tranche3Text.textContent = '3456€ + 4.20€/membre supplémentaire (501+ membres)';
    } else {
      if (tranche1aText) tranche1aText.textContent = '80€/mois fixe (1-50 membres)';
      if (tranche1bText) tranche1bText.textContent = '80€ + 1.00€/membre supplémentaire (51-250 membres)';
      if (tranche2Text) tranche2Text.textContent = '240€ + 0.60€/membre supplémentaire (251-500 membres)';
      if (tranche3Text) tranche3Text.textContent = '360€ + 0.44€/membre supplémentaire (501+ membres)';
    }
  }

  function updateBillingUI() {
    if (monthlyBtn && yearlyBtn) {
      if (isYearly) {
        // Yearly selected
        monthlyBtn.classList.remove('bg-white', 'shadow-sm', 'text-primary', 'border-primary/20', 'dark:bg-neutral-900', 'dark:text-primary-dark', 'dark:border-primary-dark');
        monthlyBtn.classList.add('text-neutral-600', 'dark:text-neutral-300', 'border-transparent');
        yearlyBtn.classList.remove('text-neutral-600', 'dark:text-neutral-300', 'border-transparent');
        yearlyBtn.classList.add('bg-white', 'shadow-sm', 'text-primary', 'border-primary/20', 'dark:bg-neutral-900', 'dark:text-primary-dark', 'dark:border-primary-dark');
      } else {
        // Monthly selected
        monthlyBtn.classList.remove('text-neutral-600', 'dark:text-neutral-300', 'border-transparent');
        monthlyBtn.classList.add('bg-white', 'shadow-sm', 'text-primary', 'border-primary/20', 'dark:bg-neutral-900', 'dark:text-primary-dark', 'dark:border-primary-dark');
        yearlyBtn.classList.remove('bg-white', 'shadow-sm', 'text-primary', 'border-primary/20', 'dark:bg-neutral-900', 'dark:text-primary-dark', 'dark:border-primary-dark');
        yearlyBtn.classList.add('text-neutral-600', 'dark:text-neutral-300', 'border-transparent');
      }
    }
  }

  // Formulaire de tarification
  const pricingForm = document.getElementById('pricing-form') as HTMLFormElement;
  const formSuccess = document.getElementById('form-success');
  const formError = document.getElementById('form-error');

  if (pricingForm) {
    pricingForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Masquer les messages précédents
      if (formSuccess) formSuccess.classList.add('hidden');
      if (formError) formError.classList.add('hidden');

      // Mettre à jour les champs cachés avec les valeurs actuelles
      const memberCountInput = document.getElementById('memberCount') as HTMLInputElement;
      const isYearlyInput = document.getElementById('isYearly') as HTMLInputElement;
      const totalPriceInput = document.getElementById('total-price') as HTMLElement;
      const pricePerMemberInput = document.getElementById('price-per-student') as HTMLElement;

      if (memberCountInput) memberCountInput.value = studentSlider.value;
      if (isYearlyInput) isYearlyInput.value = isYearly.toString();
      if (totalPriceInput) {
        const totalPriceHidden = document.getElementById('totalPrice') as HTMLInputElement;
        if (totalPriceHidden) totalPriceHidden.value = totalPriceInput.textContent || '0';
      }
      if (pricePerMemberInput) {
        const pricePerMemberHidden = document.getElementById('pricePerMember') as HTMLInputElement;
        if (pricePerMemberHidden) {
          const priceText = pricePerMemberInput.textContent || '';
          const priceMatch = priceText.match(/(\d+\.?\d*)/);
          if (priceMatch) pricePerMemberHidden.value = priceMatch[1];
        }
      }

      try {
        const formData = new FormData(pricingForm);
        const response = await fetch('/api/pricing', {
          method: 'POST',
          body: formData,
        });

        const result = await response.json();

        if (response.ok) {
          // Succès
          pricingForm.reset();
          if (formSuccess) formSuccess.classList.remove('hidden');
          pricingForm.classList.add('hidden');
        } else {
          // Erreur
          if (formError) formError.classList.remove('hidden');
        }
      } catch (error) {
        console.error('Erreur lors de l\'envoi:', error);
        if (formError) formError.classList.remove('hidden');
      }
    });
  }

  // Initialize
  updatePrices();
  updateBillingUI();
  updateTrancheTexts();
</script>
